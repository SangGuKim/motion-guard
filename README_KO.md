# Motion Guard - 웹캠 기반 움직임 감지 경고 시스템

웹캠을 활용한 간단하면서도 효과적인 움직임 감지 시스템으로, 낙상 위험이 있는 환자의 무단 이동을 방지하기 위해 개발되었습니다. 보호자의 감시 없이 침대에서 일어나는 것을 실시간으로 감지하여 경고합니다.

## 주요 기능

- 🎥 **실시간 움직임 감지** - 일반 웹캠 사용
- 🔊 **음성 경고** - 지속적인 경고음 (지속 시간 조정 가능)
- 🌙 **저조도 최적화** - 야간 모니터링 지원
- ⏸️ **경고 토글** - 스페이스바로 켜기/끄기 (설정 시간 후 자동 재활성화)
- 🎛️ **민감도 조정** - 명령행 인자로 간편하게 설정
- 🔄 **히스테리시스 필터링** - 오탐 감소
- 🪶 **경량 시스템** - 웹캠이 있는 모든 노트북에서 실행 가능

## 빠른 시작

### 설치

```bash
pip install opencv-python numpy pygame
```

또는 requirements.txt 사용:

```bash
pip install -r requirements.txt
```

### 기본 사용법

```bash
# 기본 설정으로 실행 (민감도: 5, 최소영역: 100, 경고음: 3초, 자동재활성화: 5분)
python motion_detector.py

# 선호하는 설정으로 실행
python motion_detector.py -s 5 -m 100 -d 3 -r 300
```

### 조작 방법

- **스페이스바**: 경고 켜기/끄기 (설정 시간 후 자동으로 다시 활성화)
- **Q**: 종료

## 명령행 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `-s, --sensitivity` | 민감도 임계값 (낮을수록 민감) | 5 |
| `-m, --min-area` | 최소 움직임 영역 (픽셀) | 100 |
| `-d, --duration` | 경고음 지속 시간 (초) | 3.0 |
| `-r, --auto-resume` | 자동 재활성화 시간 (초) | 300 (5분) |

### 사용 예시

```bash
# 작은 움직임 감지를 위한 높은 민감도
python motion_detector.py -s 3

# 오탐 감소를 위한 낮은 민감도
python motion_detector.py -s 10 -m 200

# 경고음 지속 시간 연장
python motion_detector.py -d 5

# 10분 후 자동 재활성화
python motion_detector.py -r 600

# 모든 옵션 조합
python motion_detector.py -s 5 -m 100 -d 3 -r 300
```

## 작동 원리

### 움직임 감지
- 웹캠에서 비디오 프레임 캡처
- 그레이스케일 변환 및 가우시안 블러 적용
- 연속 프레임 비교를 통한 변화 감지
- 임계값 및 윤곽선 감지 적용
- **히스테리시스** (3프레임 확인) 적용으로 노이즈 필터링

### 경고 동작
- 연속 경고음: 0.5초 경고음 + 0.5초 휴지 = 1초 간격
- 새로운 움직임 감지 시 지속 시간 재설정
- 스페이스바로 일시적으로 비활성화 가능
- 설정된 시간 후 자동으로 재활성화

### 시각적 피드백
- 감지된 움직임 주변에 빨간색 사각형 표시
- 화면에 상태 표시:
  - `Monitoring...` - 활성 모니터링 중 (녹색)
  - `Motion...` - 움직임 감지됨 (주황색)
  - `ALARM ACTIVE!` - 경고음 울림 중 (빨간색)
  - `ALARM DISABLED (XXs)` - 일시적으로 비활성화됨 (회색)

## 활용 사례

- **낙상 예방** - 노인 또는 회복 중인 환자
- **침대 옆 모니터링** - 야간 시간대
- **움직임 경고** - 무단 이동이 위험한 환자
- **일반 움직임 감지** - 모든 모니터링 시나리오

## 설정 가이드

### 기본 설정
1. **노트북 위치** - 침대에서 1-2미터 거리에 전체가 보이도록 배치
2. **전원 설정** - 화면 절전 모드 비활성화 및 전원 연결 유지
3. **볼륨 설정** - 시스템 볼륨을 크게 설정하거나 외부 스피커 사용
4. **민감도 테스트** - 오탐 없이 움직임을 안정적으로 감지할 때까지 `-s` 값 조정

### 저조도 환경 운용 (야간 사용 시 필수)

**중요**: 일반 웹캠은 저조도 환경에서 사람의 윤곽을 구분하지 못합니다. 취침등 정도의 조명으로는 움직임을 직접 감지할 수 없습니다. 대신 **광차단 방식**을 사용합니다.

#### 광차단 감지 방식 (실제 검증된 방법)

**핵심 원리**: 카메라가 사람을 보는 것이 아니라, **취침등 불빛 자체를 관찰**합니다. 환자가 일어나면 카메라와 취침등 사이를 가려서 불빛이 사라지는 순간을 감지합니다.

**실제 설정 예시:**
```
[침대 헤드]
    ↓ 
  [취침등] ← 카메라가 이 불빛을 관찰
    ↓
[환자 침대] ← 환자가 일어나면 불빛을 가림
    ↓
[협탁 + 노트북(카메라)]
```

**단계별 설정:**

1. **조명 배치**: 침대 헤드 위에 작은 취침등 설치
   - LED 수면등, 작은 무드등 등 사용
   - 위치: 침대 헤드보드 상단 또는 벽면

2. **카메라 위치**: 침대 다리쪽 협탁에 노트북 배치
   - 카메라가 취침등 불빛을 정면으로 보도록 조정
   - 화면에는 **불빛만 보이면 정상** (사람 윤곽 안 보여도 됨)

3. **카메라 높이 조정**: 
   - 노트북 밑에 책이나 받침대를 놓아 높이 조절
   - 환자가 다리를 세우고 누워있을 때는 불빛이 보이도록
   - 환자가 상체를 일으킬 때 불빛을 완전히 가리도록

4. **전원 관리**:
   - 노트북 전원 연결 시 절전 모드 비활성화
   - 스크린만 1분 후 꺼지도록 설정 (배터리 절약 및 눈부심 방지)
   - Windows: 설정 > 시스템 > 전원 > 화면 및 절전
   - macOS: 시스템 환경설정 > 배터리 > 전원 어댑터

**공간이 부족한 경우:**
- 침대 다리쪽에 협탁을 놓을 공간이 없다면 침대 옆 대각선 위치에 배치
- 중요한 것은 "카메라 - 환자 - 취침등"이 일직선상에 있어야 함
- 환자가 일어날 때 불빛을 가리는 구도 확보

**조명을 여러 개 사용하는 방법:**
- 취침등이 여러 개 있다면 모두 활용 가능
- 각 조명이 다른 위치에 있으면 더 촘촘한 감지 가능
- 예: 침대 헤드 양쪽에 조명 → 환자가 어느 방향으로 일어나도 감지
- 예: 침대 헤드 + 사이드 테이블 조명 → 더 넓은 감지 영역
- 모든 조명이 카메라 화면에 보이도록 배치
- **장점**: 환자가 몸을 비틀거나 한쪽으로 일어나도 확실히 감지
- **단점**: 조명이 많으면 수면에 방해될 수 있음 (개인차 있음)

#### 감지 원리 및 히스테리시스

**왜 이 방식이 작동하는가:**
- 저조도에서 웹캠은 밝은 점광원(취침등)은 감지 가능
- 환자가 상체를 일으키면 불빛이 급격히 감소/사라짐
- 이 밝기 변화를 움직임으로 감지

**히스테리시스 처리:**
- 연속 3프레임 이상 감지되어야 경고 시작
- **한 번 경고가 시작되면 설정한 시간(기본 3초) 동안 지속**
- 불빛이 아주 잠깐만 가려져도 경고가 울리기 시작하면 계속 울림
- 이는 환자가 재빨리 움직이는 경우도 놓치지 않기 위함

**추천 설정값 (광차단 방식):**
```bash
# 밝기 변화에 민감하게 반응
python motion_detector.py -s 5 -m 100 -d 3
```

- 민감도 `-s 5~7`: 밝기 변화 감지에 적합
- 최소영역 `-m 50~150`: 불빛 영역 크기에 따라 조정
- 지속시간 `-d 3`: 잠깐 가려져도 충분히 울리도록

#### 설치 후 필수 테스트

1. **프로그램 실행**
   ```bash
   python motion_detector.py -s 5 -m 100
   ```

2. **화면 확인**: 
   - 영상에 취침등 불빛이 밝은 점으로 보이는지 확인
   - 조명이 여러 개면 모든 불빛이 보이는지 확인
   - **사람이 안 보여도 정상입니다** (불빛만 보이면 됨)
   - 조명이 하나만 있어도 충분히 작동함

3. **감지 테스트**:
   - 침대에 누운 자세: 감지 안 됨 (불빛이 보임)
   - 다리를 세운 자세: 감지 안 됨 (불빛이 여전히 보임)
   - 상체를 일으킨 자세: **감지됨** (불빛이 가려짐)
   - 침대에서 일어남: **확실히 감지됨**

4. **조정이 필요한 경우**:
   - 감지가 안 되면: 카메라 높이를 낮추거나 민감도를 높임 (`-s 3`)
   - 너무 자주 울리면: 카메라 높이를 높이거나 민감도를 낮춤 (`-s 7`)

#### 야간 운용 체크리스트

**설치 단계:**
- [ ] 취침등을 침대 헤드에 설치 및 점등
- [ ] 노트북을 침대 다리쪽 협탁에 배치
- [ ] 카메라 높이 조정 (책/받침대 사용)
- [ ] 화면에 취침등 불빛이 보이는지 확인

**설정 단계:**
- [ ] 노트북 전원 연결
- [ ] 절전 모드 비활성화
- [ ] 화면 자동 꺼짐 설정 (선택사항)
- [ ] 볼륨 크기 확인 (또는 외부 스피커)

**테스트 단계:**
- [ ] 누운 자세에서 감지 안 되는지 확인
- [ ] 상체를 일으킬 때 감지되는지 확인
- [ ] 스페이스바로 경고 끄기 테스트
- [ ] 자동 재활성화 시간 확인

#### 이 방식의 장단점

**장점:**
- ✅ 완전히 어두운 방에서도 작동
- ✅ 저가의 웹캠으로 충분
- ✅ 취침등 하나만 있으면 됨
- ✅ 환자가 일어나는 동작에만 반응

**단점:**
- ❌ 뒤척이는 정도의 움직임은 감지 불가
- ❌ 신루관 접힘 등 세밀한 자세 변화 감지 불가
- ❌ 카메라-환자-조명 배치가 중요

**다른 모니터링이 필요한 경우:**
- 환자의 자세 변화나 뒤척임을 감지해야 한다면 **더 밝은 조명 필요**
- 무드등/스탠드로 환자의 윤곽이 보일 정도의 조명 제공
- 이 경우 직접 움직임 감지 가능하나 저조도 성능은 여전히 제한적

**핵심 원칙:**
> 이 시스템은 **"침대 이탈 감지"**에 특화되어 있습니다. 환자가 침대에서 일어나려는 순간을 감지하여 낙상을 예방하는 것이 목적입니다. 세밀한 자세 모니터링이 필요하다면 전문 의료 장비 사용을 권장합니다.

## 문제 해결

### 경고가 너무 자주 울림
```bash
# 민감도 감소 (임계값 증가)
python motion_detector.py -s 10
# 또는
python motion_detector.py -s 15
```

### 움직임을 놓침
```bash
# 민감도 증가 (임계값 감소)
python motion_detector.py -s 3
```

### 경고음이 너무 짧음
```bash
# 경고음 지속 시간 연장
python motion_detector.py -d 5
```

### 소리가 나지 않음
- pygame 올바른 설치 확인: `pip install pygame`
- 시스템 볼륨이 음소거되지 않았는지 확인
- pygame을 사용할 수 없는 경우 시스템 경고음(`\a`)이 대신 사용됨

## 기술 요구사항

- Python 3.6+
- 웹캠 (내장형 또는 USB)
- OpenCV
- NumPy
- Pygame (선택사항, 없을 경우 시스템 경고음으로 대체)

## 개인정보 보호 및 윤리

이 도구는 정당한 간병 목적으로 설계되었습니다. 다음을 준수해 주세요:
- ✅ 모니터링 대상자의 사전 동의 하에만 사용
- ✅ 환자의 적절한 개인정보 보호 및 존엄성 보장
- ✅ 전문적인 의료 서비스를 대체하지 않는 보조 도구로만 사용
- ❌ 무단 감시 목적으로 사용 금지

## 라이선스

MIT License - 필요에 따라 자유롭게 사용 및 수정 가능합니다.

## 기여

기여를 환영합니다! 이 프로젝트는 긴급 상황에서 만들어졌으며 항상 개선의 여지가 있습니다:
- 향상된 움직임 감지 알고리즘
- 모바일 앱 알림
- 다중 카메라 지원
- 클라우드 녹화 옵션
- 머신러닝 기반 낙상 감지

## 감사의 말

가족의 안전을 위해 긴급하게 만들어졌습니다. 이것이 다른 간병인이 조금이라도 더 편히 쉴 수 있도록 돕는다면 그 목적을 다한 것입니다.

---

**면책 조항**: 이것은 기본적인 모니터링 도구이며 전문 의료 장비나 적절한 환자 감독을 대체할 수 없습니다. 적절한 환자 간호를 위해 항상 의료 전문가와 상담하십시오.